

# info about FAT12 in chapter 4

## 1 空pm.img软盘文件

```bash

mkdir c4/fat12/ 
cd c4/fat12/ 
ln -snf ../../b/bochsrc .
ln -snf ../../b/freedos.img .

# gen a floppy image file named pm.img
bximage 

hexdump pm.img
# 0000000 0000 0000 0000 0000 0000 0000 0000 0000
# *
# 0168000

# 说明pm.img所有字节都是0

bochs
# 按第三章开始提到的方法，在启动的freedos中格式化pm.img。
# 直接使用dos命令： format.exe b: 即可完成。

# 再使用hexdump时，即可以看到pm.img的内容已经变化。
hexdump pm.img
# 0000000 3ceb 4690 6572 4465 534f 0000 0102 0001
# 0000010 e002 4000 f00b 0009 0012 0002 0000 0000
# 0000020 0000 0000 0001 0029 0000 2000 2020 2020
# 0000030 2020 2020 2020 4146 3154 2032 2020 1f0e
# 0000040 5bbe ac7c c022 0b74 b456 bb0e 0007 10cd
# 0000050 eb5e 32f0 cde4 cd16 eb19 54fe 6968 2073
# 0000060 7369 6e20 746f 6120 6220 6f6f 6174 6c62
# 0000070 2065 6964 6b73 202e 5020 656c 7361 2065
# 0000080 6e69 6573 7472 6120 6220 6f6f 6174 6c62
# 0000090 2065 6c66 706f 7970 6120 646e 0a0d 7270
# 00000a0 7365 2073 6e61 2079 656b 2079 6f74 7420
# 00000b0 7972 6120 6167 6e69 2e20 2e2e 0d20 000a
# 00000c0 0001 0000 0000 0000 0000 0000 0000 0000
# 00000d0 0000 0000 0000 0000 0000 0000 0000 0000
# *
# 00001f0 0000 0000 0000 0000 0000 0000 0000 aa55
# 0000200 fff0 00ff 0000 0000 0000 0000 0000 0000
# 0000210 0000 0000 0000 0000 0000 0000 0000 0000
# *
# 0001400 fff0 00ff 0000 0000 0000 0000 0000 0000
# 0001410 0000 0000 0000 0000 0000 0000 0000 0000
# *
# 0168000

# 还可以使用xxd pm.img |less 来查看上述字节的具体信息。
xxd 1 pm.img | less 

# 0000000: eb3c 9046 7265 6544 4f53 0000 0201 0100  .<.FreeDOS......
# 0000010: 02e0 0040 0bf0 0900 1200 0200 0000 0000  ...@............
# 0000020: 0000 0000 0100 2900 0000 0020 2020 2020  ......)....     
# 0000030: 2020 2020 2020 4641 5431 3220 2020 0e1f        FAT12   ..
# 0000040: be5b 7cac 22c0 740b 56b4 0ebb 0700 cd10  .[|.+.t.V.......
# 0000050: 5eeb f032 e4cd 16cd 19eb fe54 6869 7320  ^..2.......This 
# 0000060: 6973 206e 6f74 2061 2062 6f6f 7461 626c  is not a bootabl
# 0000070: 6520 6469 736b 2e20 2050 6c65 6173 6520  e disk.  Please 
# 0000080: 696e 7365 7274 2061 2062 6f6f 7461 626c  insert a bootabl
# 0000090: 6520 666c 6f70 7079 2061 6e64 0d0a 7072  e floppy and..pr
# 00000a0: 6573 7320 616e 7920 6b65 7920 746f 2074  ess any key to t
# 00000b0: 7279 2061 6761 696e 202e 2e2e 200d 0a00  ry again ... ...
# 00000c0: 0100 0000 0000 0000 0000 0000 0000 0000  ................
# ...
# 00001f0: 0000 0000 0000 0000 0000 0000 0000 55aa  ..............U.
# 0000200: f0ff ff00 0000 0000 0000 0000 0000 0000  ................
# ...
```

下面来分析上述格式化后的pm.img文件的首扇区。以与书上的表4-1对比。

## 2 FAT12格式

### 2.1 FAT12引导扇区格式

|   名称       | 偏移 | 长度 |   内容数值    |   说明          |
|  :------:    | ----:| :--: |  :--------:    |   :---          |
| BS_jmpBoot   |    0 |  3   | jmp +3c ; nop | jmp short       |
| BS_OEMName   |    3 |  8   | 'FreeDOS_'    | 厂商名          |
|              |   11 |  2   |  0x0200       | 每扇区字节数=512|
|              |   13 |  1   |    0x01       | 每簇字节数=1    |
|              |   14 |  2   |  0x0001       | MBR占用字节数=1 |
|              |   16 |  1   |    0x02       | 有多少FAT表=2   |
|BPB_RootEntCnt|   17 |  2   |  0x00E0       | 根目录文件最大数=224 |
|BPB_TotSec16  |   19 |  2   |  0x0B40       | 扇区总数=2880   |
|              |   21 |  1   |    0xF0       | 介质描述符=240  |
|              |   22 |  2   |  0x0009       | 每FAT表扇区数=9 |
|              |   24 |  2   |  0x0012       | 每磁道扇区数=18 |
|              |   26 |  2   |  0x0002       | 磁头(页)数=2    |
|              |   28 |  4   |  0x00000000   | 隐藏扇区数=0    |
| BPB_TotSec32 |   32 |  4   |  0x00000000   | TotSec16若为0则此写扇区总数 |
|              |   36 |  1   |    0x01       | 中断13的驱动器号=1  |
|              |   37 |  1   |    0x00       | not used            |
|              |   38 |  1   |    0x29       | 扩展引导标记=0x29   |
| BS_VolID     |   39 |  4   |  0x00000000   | 卷序列号=0          |
| BS_VolLab    |   43 |  11  |  11个空格'_'  | 卷标                |
|              |   54 |  8   |  ‘FAT12_-_’   | 文件系统类型        |
|              |   62 | 448  |  code,data    | 引导代码剩余空间填0 |
|              |  510 |  2   |  0xAA55       | 结束标志            |

偏移36处，中断13的驱动器号=1因为是在A盘下格式化成的B盘。
根目录文件最大数为224，每个文件属性占用32字节。共224*32=7168=14扇区


### 2.2 FAT12根目录区条目格式

|   名称    |  偏移  | 长度  |       说明         |
|  :------: | ----:  | :--:  |       :---         |
| Name      |   0x00 |  0xB  | 文件名8B，扩展名3B |
| Attr      |   0x0B |   1   | 文件属性　         |
| Reserved  |   0x0C |  0xA  | 保留位             |
| WriteTime |   0x16 |  2    | 最后一次写入时间   |
| WriteDate |   0x18 |  2    | 最后一次写入日期   |
| FirstClus |   0x1A |  2    | 对应文件的开始簇号 |
| FileSize  |   0x1C |  4    | 文件大小           |

生成文件并写入软盘来观察。

```bash
mkdir files/ 

# river.txt
for i in {1..5};do echo -n 'river' ;done >> files/RIVER.TXT

# flower.txt
for i in  {1..300}; do echo -n 'flower';done >> files/FLOWER.txt
wc -l flower.txt

# tree.txt
for i in {1..4};do echo -n 'tree' ;done >> files/tree.txt


sudo mount -o loop pm.img  /mnt/floppy/
sudo ls -l /mnt/floppy/

sudo cp -rv files/RIVER.TXT   /mnt/floppy/
sudo cp -rv files/FLOWER.txt  /mnt/floppy/
sudo cp -rv files/tree.txt    /mnt/floppy/

sudo ls -l   /mnt/floppy/
sudo umount  /mnt/floppy/

# 观察
xxd  -u -a -g 1 -c 16 -s +0x2600 -l 512 pm.img

0002600: 52 49 56 45 52 20 20 20 54 58 54 20 00 00 49 75  RIVER   TXT ..Iu
0002610: 3D 47 3D 47 00 00 49 75 3D 47 03 00 19 00 00 00  =G=G..Iu=G......
0002620: 41 46 00 4C 00 4F 00 57 00 45 00 0F 00 57 52 00  AF.L.O.W.E...WR.
0002630: 2E 00 74 00 78 00 74 00 00 00 00 00 FF FF FF FF  ..t.x.t.........
0002640: 46 4C 4F 57 45 52 20 20 54 58 54 20 00 00 4E 75  FLOWER  TXT ..Nu
0002650: 3D 47 3D 47 00 00 4E 75 3D 47 04 00 08 07 00 00  =G=G..Nu=G......
0002660: 41 74 00 72 00 65 00 65 00 2E 00 0F 00 28 74 00  At.r.e.e.....(t.
0002670: 78 00 74 00 00 00 FF FF FF FF 00 00 FF FF FF FF  x.t.............
0002680: 54 52 45 45 20 20 20 20 54 58 54 20 00 00 51 75  TREE    TXT ..Qu
0002690: 3D 47 3D 47 00 00 51 75 3D 47 08 00 10 00 00 00  =G=G..Qu=G......
00026a0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
*
00027f0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
```
不明白为什么多了两个条目。而且是以字母A开头。但从其放置文件的簇(扇区)号及大小如下：

|   名称     |开始扇区号|     字节数     | 扇区数 |       说明         |
|  :------:  |   ----:  |      :---      |  :--:  |       ---:         |
| RIVER.TXT  |   0x03   | 0x00000019=25  |   1    | |
| FLOWER.txt |   0x04   | 0x00000708=1800|   4    | 1800/512=3.5       |
| tree.txt   |   0x08   | 0x00000010=16  |   1    | |

FLOWER.txt占4-7号扇区。需要注意的是，文件在数据区的开始扇区（簇）号是从2开始的。但上面的第一个文件竟然是从3号开始的，说明数据区的首扇区是空出来了。
 
### 2.3 FAT12数据区
MBR占1字节，分区各占9字节，共2个。目录区如之前计算，占14字节。
故数据区前面0-32扇区，共33个。
数据区首字节在33*512=0x4200。另如上观察。数据区的首扇区空出来的。故RIVER.TXT的数据是从34号扇区开始的。下面观察来验证。可以看出三个文件的长度都是正常的。而且34号扇区确实是未使用。是从35号扇区开始写的RIVER.TXT文件的。

```bash
xxd  -u -a -g 1 -c 16 -s +0x4200 -l 1024 pm.img
0004200: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
*
0004400: 72 69 76 65 72 72 69 76 65 72 72 69 76 65 72 72  riverriverriverr
0004410: 69 76 65 72 72 69 76 65 72 00 00 00 00 00 00 00  iverriver.......
0004420: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
*
0004600: 66 6C 6F 77 65 72 66 6C 6F 77 65 72 66 6C 6F 77  flowerflowerflow
0004610: 65 72 66 6C 6F 77 65 72 66 6C 6F 77 65 72 66 6C  erflowerflowerfl
...

xxd  -u -a -g 1 -c 16 -s +0x4c00 -l 1024 pm.img
0004c00: 66 6C 6F 77 65 72 66 6C 6F 77 65 72 66 6C 6F 77  flowerflowerflow
...
0004cf0: 66 6C 6F 77 65 72 66 6C 6F 77 65 72 66 6C 6F 77  flowerflowerflow
0004d00: 65 72 66 6C 6F 77 65 72 00 00 00 00 00 00 00 00  erflower........
0004d10: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
*
0004e00: 74 72 65 65 74 72 65 65 74 72 65 65 74 72 65 65  treetreetreetree
0004e10: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
*
0004ff0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
```

### 2.4 FAT12分区表
FAT12格式下，软盘2800个扇区的作用是这样分布的：
> * 扇区0： MBR，主引导扇区， 共1个扇区；
> * 扇区 1- 9：FAT1，分区表1，共9个扇区；
> * 扇区10-18：FAT2，分区表2，是FAT1的备份。共 9个扇区；
> * 扇区19-32：根目录区。共14个扇区；
> * 扇区33-E ：数据区。其编号从2开始。故33扇区对应数据区2，34扇区对就数据区3号扇区。


FAT区内，每12bits为一个FAT项，且前2项是不使用的。对应数据区的开始扇区号为2。之后的每个FAT项对应数据区的一个扇区（簇）号。
FAT的值代表的是文件的下一个簇（扇区）号。若其值不小于0xFF8，则是最后一个扇区。0xFF7则表示坏区。

观察FAT1区的内容
```bash
xxd  -u -a -g 1 -c 16 -s +0x1400 -l 512 pm.img
0001400: F0 FF FF 00 F0 FF 05 60 00 07 F0 FF FF 0F 00 00  .......`........
0001410: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
*
00015f0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................

xxd  -u -a -g 1 -c 16 -s +0x200 -l 512 pm.img
0000200: F0 FF FF 00 F0 FF 05 60 00 07 F0 FF FF 0F 00 00  .......`........
0000210: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
*
00003f0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
# 可见FAT1与FAT2 内容相同。

```

用上述观察数据来分析。
原始数据左边低字节：F0 FF FF 00 F0 FF 05 60 00 07 F0 FF FF 0F 00 00

调整为左边高字节序：00 00 0F FF FF F0 07 00 60 05 FF F0 00 FF FF F0

再调整为FAT项(左高)：00 000 FFF FFF 007 006 005 FFF 000 FFF FF0

整理成表如下：

| 簇号 | FAT值  |  对应文件  |下一扇区号|
| :--: | :---:  |   :---     | :--: |
|  9   |  000   | -          |  -   |
|  8   |  FFF   | tree.txt   | 结束 |
|  7   |  FFF   | FLOWER.TXT | 结束 |
|  6   |  007   | FLOWER.TXT | 007  |
|  5   |  006   | FLOWER.TXT | 006  |
|  4   |  005   | FLOWER.TXT | 005  |
|  3   |  FFF   | RIVER.TXT  | 结束 |
|  2   |  000   | 未知     |  -     |
|  1   |  FFF   | 不用     |  -     |
|  0   |  FF0   | 不用     |  -     |




## 3 观察目录在FAT12中的记录

```bash
# cat and dog
mkdir files/house/ 
for i in {1..3};do echo -n 'cat' ;done >> files/house/cat.TXT
for i in {1..3};do echo -n 'dog' ;done >> files/house/dog.TXT
cd -

sudo mount -o loop pm.img  /mnt/floppy/
sudo cp -rv files/house/    /mnt/floppy/
sudo ls -l   /mnt/floppy/
sudo umount  /mnt/floppy/

xxd  -u -a -g 1 -c 16 -s +0x2600 -l 512 pm.img
0002600: 52 49 56 45 52 20 20 20 54 58 54 20 00 00 49 75  RIVER   TXT ..Iu
0002610: 3D 47 3D 47 00 00 49 75 3D 47 03 00 19 00 00 00  =G=G..Iu=G......
...
00026a0: 41 68 00 6F 00 75 00 73 00 65 00 0F 00 08 00 00  Ah.o.u.s.e......
00026b0: FF FF FF FF FF FF FF FF FF FF 00 00 FF FF FF FF  ................
00026c0: 48 4F 55 53 45 20 20 20 20 20 20 10 00 00 C6 82  HOUSE      .....
00026d0: 3D 47 3D 47 00 00 C6 82 3D 47 09 00 00 00 00 00  =G=G....=G......
...

```
可见目录和文件的Attr属性不同，文件是20，目录是10。另外目录的谁的长度属性为0。本次house目录的开始簇号为0x0009。即在之前三个文件的后面。下面观察一下对应的9号数据扇区。因为前面33号是对应2号数据扇区，地址为0x4200h，故9号在0x5000h。

```bash
xxd  -u -a -g 1 -c 16 -s +0x4e00 -l 1024 pm.img
0004e00: 74 72 65 65 74 72 65 65 74 72 65 65 74 72 65 65  treetreetreetree
0004e10: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
*
0005000: 2E 20 20 20 20 20 20 20 20 20 20 10 00 00 C6 82  .          .....
0005010: 3D 47 3D 47 00 00 C6 82 3D 47 09 00 00 00 00 00  =G=G....=G......
0005020: 2E 2E 20 20 20 20 20 20 20 20 20 10 00 00 C6 82  ..         .....
0005030: 3D 47 3D 47 00 00 C6 82 3D 47 00 00 00 00 00 00  =G=G....=G......
0005040: 41 43 00 41 00 54 00 2E 00 74 00 0F 00 20 78 00  AC.A.T...t... x.
0005050: 74 00 00 00 FF FF FF FF FF FF 00 00 FF FF FF FF  t...............
0005060: 43 41 54 20 20 20 20 20 54 58 54 20 00 00 C6 82  CAT     TXT ....
0005070: 3D 47 3D 47 00 00 C6 82 3D 47 0A 00 0C 00 00 00  =G=G....=G......
0005080: 41 44 00 4F 00 47 00 2E 00 74 00 0F 00 0A 78 00  AD.O.G...t....x.
0005090: 74 00 00 00 FF FF FF FF FF FF 00 00 FF FF FF FF  t...............
00050a0: 44 4F 47 20 20 20 20 20 54 58 54 20 00 00 C6 82  DOG     TXT ....
00050b0: 3D 47 3D 47 00 00 C6 82 3D 47 0B 00 0C 00 00 00  =G=G....=G......
00050c0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................

xxd  -u -a -g 1 -c 16 -s +0x5200 -l 1024 pm.img
0005200: 63 61 74 63 61 74 63 61 74 63 61 74 00 00 00 00  catcatcatcat....
0005210: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
*
0005400: 64 6F 67 64 6F 67 64 6F 67 64 6F 67 00 00 00 00  dogdogdogdog....
0005410: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
*
00055f0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
```
从这个扇区来看，该扇区是相当于house目录单独的FAT表，而且其前2项也是没有使用的。cat.txt文件是从0x5040地址开始的。
cat.txt文件的开始扇区是0x000A，长度为0x0000000C。
dog.txt文件的开始扇区是0x000B，长度为0x0000000C。

### FAT表对比
```bash
 xxd  -u -a -g 1 -c 16 -s +0x200 -l 512 pm.img
0000200: F0 FF FF 00 F0 FF 05 60 00 07 F0 FF FF FF FF FF  .......`........
0000210: FF FF 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................
*
00003f0: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00  ................

#  下面两列是添加目前之前的FAT项值
0000200: F0 FF FF 00 F0 FF 05 60 00 07 F0 FF FF 0F 00 00  .......`........
0000210: 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 

# originB : 07 F0 FF FF FF FF FF FF FF 00
# leftHigh: 00 FF FF FF FF FF FF FF F0 07
# leftHigh: - -00 FFF FFF FFF FFF FFF 007

```

整理上面的变化如下：

| 簇号 | FAT值  |  对应文件  |下一扇区号|
| :--: | :---:  |   :---     | :--: |
|  C   |  000   |    -       |  -   |
|  B   |  FFF   | dog.txt    | 结束 |
|  A   |  FFF   | cat.txt    | 结束 |
|  9   |  FFF   | house/     | 结束 |
|  8   |  FFF   | tree.txt   | 结束 |
|  7   |  FFF   | FLOWER.TXT | 结束 |
|  6   |  007   | FLOWER.TXT |  7   |




